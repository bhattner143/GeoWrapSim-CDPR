
clc; clear; 
close all;
CASPR_log.SetLoggingDetails(CASPRLogLevel.INFO);
%%
kTeapotNumPatches  = 32;
kTeapotNumVertices = 306;

teapotPatches = [
	[  1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,  14,  15,  16];
	[  4,  17,  18,  19,   8,  20,  21,  22,  12,  23,  24,  25,  16,  26,  27,  28];
	[ 19,  29,  30,  31,  22,  32,  33,  34,  25,  35,  36,  37,  28,  38,  39,  40];
	[ 31,  41,  42,   1,  34,  43,  44,   5,  37,  45,  46,   9,  40,  47,  48,  13];
	[ 13,  14,  15,  16,  49,  50,  51,  52,  53,  54,  55,  56,  57,  58,  59,  60];
	[ 16,  26,  27,  28,  52,  61,  62,  63,  56,  64,  65,  66,  60,  67,  68,  69];
	[ 28,  38,  39,  40,  63,  70,  71,  72,  66,  73,  74,  75,  69,  76,  77,  78];
	[ 40,  47,  48,  13,  72,  79,  80,  49,  75,  81,  82,  53,  78,  83,  84,  57];
	[ 57,  58,  59,  60,  85,  86,  87,  88,  89,  90,  91,  92,  93,  94,  95,  96];
	[ 60,  67,  68,  69,  88,  97,  98,  99,  92, 100, 101, 102,  96, 103, 104, 105];
	[ 69,  76,  77,  78,  99, 106, 107, 108, 102, 109, 110, 111, 105, 112, 113, 114];
	[ 78,  83,  84,  57, 108, 115, 116,  85, 111, 117, 118,  89, 114, 119, 120,  93];
	[121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136];
	[124, 137, 138, 121, 128, 139, 140, 125, 132, 141, 142, 129, 136, 143, 144, 133];
	[133, 134, 135, 136, 145, 146, 147, 148, 149, 150, 151, 152,  69, 153, 154, 155];
	[136, 143, 144, 133, 148, 156, 157, 145, 152, 158, 159, 149, 155, 160, 161,  69];
	[162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177];
	[165, 178, 179, 162, 169, 180, 181, 166, 173, 182, 183, 170, 177, 184, 185, 174];
	[174, 175, 176, 177, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197];
	[177, 184, 185, 174, 189, 198, 199, 186, 193, 200, 201, 190, 197, 202, 203, 194];
	[204, 204, 204, 204, 207, 208, 209, 210, 211, 211, 211, 211, 212, 213, 214, 215];
	[204, 204, 204, 204, 210, 217, 218, 219, 211, 211, 211, 211, 215, 220, 221, 222];
	[204, 204, 204, 204, 219, 224, 225, 226, 211, 211, 211, 211, 222, 227, 228, 229];
	[204, 204, 204, 204, 226, 230, 231, 207, 211, 211, 211, 211, 229, 232, 233, 212];
	[212, 213, 214, 215, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 244, 245];
	[215, 220, 221, 222, 237, 246, 247, 248, 241, 249, 250, 251, 245, 252, 253, 254];
	[222, 227, 228, 229, 248, 255, 256, 257, 251, 258, 259, 260, 254, 261, 262, 263];
	[229, 232, 233, 212, 257, 264, 265, 234, 260, 266, 267, 238, 263, 268, 269, 242];
	[270, 270, 270, 270, 279, 280, 281, 282, 275, 276, 277, 278, 271, 272, 273, 274];
	[270, 270, 270, 270, 282, 289, 290, 291, 278, 286, 287, 288, 274, 283, 284, 285];
	[270, 270, 270, 270, 291, 298, 299, 300, 288, 295, 296, 297, 285, 292, 293, 294];
	[270, 270, 270, 270, 300, 305, 306, 279, 297, 303, 304, 275, 294, 301, 302, 271]];

teapotVertices = 0.1*[
	[ 1.4000,  0.0000,  2.4000];                                                     
	[ 1.4000, -0.7840,  2.4000];                                                     
	[ 0.7840, -1.4000,  2.4000];                                                     
	[ 0.0000, -1.4000,  2.4000];                                                     
	[ 1.3375,  0.0000,  2.5312];                                                     
	[ 1.3375, -0.7490,  2.5312];                                                     
	[ 0.7490, -1.3375,  2.5312];                                                     
	[ 0.0000, -1.3375,  2.5312];                                                     
	[ 1.4375,  0.0000,  2.5312];                                                     
	[ 1.4375, -0.8050,  2.5312];                                                     
	[ 0.8050, -1.4375,  2.5312];                                                     
	[ 0.0000, -1.4375,  2.5312];                                                     
	[ 1.5000,  0.0000,  2.4000];                                                     
	[ 1.5000, -0.8400,  2.4000];                                                     
	[ 0.8400, -1.5000,  2.4000];                                                     
	[ 0.0000, -1.5000,  2.4000];                                                     
	[-0.7840, -1.4000,  2.4000];                                                     
	[-1.4000, -0.7840,  2.4000];                                                     
	[-1.4000,  0.0000,  2.4000];                                                     
	[-0.7490, -1.3375,  2.5312];                                                     
	[-1.3375, -0.7490,  2.5312];                                                     
	[-1.3375,  0.0000,  2.5312];                                                     
	[-0.8050, -1.4375,  2.5312];                                                     
	[-1.4375, -0.8050,  2.5312];                                                     
	[-1.4375,  0.0000,  2.5312];                                                     
	[-0.8400, -1.5000,  2.4000];                                                     
	[-1.5000, -0.8400,  2.4000];                                                     
	[-1.5000,  0.0000,  2.4000];                                                     
	[-1.4000,  0.7840,  2.4000];                                                     
	[-0.7840,  1.4000,  2.4000];                                                     
	[ 0.0000,  1.4000,  2.4000];                                                     
	[-1.3375,  0.7490,  2.5312];                                                     
	[-0.7490,  1.3375,  2.5312];                                                     
	[ 0.0000,  1.3375,  2.5312];                                                     
	[-1.4375,  0.8050,  2.5312];                                                     
	[-0.8050,  1.4375,  2.5312];                                                     
	[ 0.0000,  1.4375,  2.5312];                                                     
	[-1.5000,  0.8400,  2.4000];                                                     
	[-0.8400,  1.5000,  2.4000];                                                     
	[ 0.0000,  1.5000,  2.4000];                                                     
	[ 0.7840,  1.4000,  2.4000];                                                     
	[ 1.4000,  0.7840,  2.4000];                                                     
	[ 0.7490,  1.3375,  2.5312];                                                     
	[ 1.3375,  0.7490,  2.5312];                                                     
	[ 0.8050,  1.4375,  2.5312];                                                     
	[ 1.4375,  0.8050,  2.5312];                                                     
	[ 0.8400,  1.5000,  2.4000];                                                     
	[ 1.5000,  0.8400,  2.4000];                                                     
	[ 1.7500,  0.0000,  1.8750];                                                     
	[ 1.7500, -0.9800,  1.8750];                                                     
	[ 0.9800, -1.7500,  1.8750];                                                     
	[ 0.0000, -1.7500,  1.8750];                                                     
	[ 2.0000,  0.0000,  1.3500];                                                     
	[ 2.0000, -1.1200,  1.3500];                                                     
	[ 1.1200, -2.0000,  1.3500];                                                     
	[ 0.0000, -2.0000,  1.3500];                                                     
	[ 2.0000,  0.0000,  0.9000];                                                     
	[ 2.0000, -1.1200,  0.9000];                                                     
	[ 1.1200, -2.0000,  0.9000];                                                     
	[ 0.0000, -2.0000,  0.9000];                                                     
	[-0.9800, -1.7500,  1.8750];                                                     
	[-1.7500, -0.9800,  1.8750];                                                     
	[-1.7500,  0.0000,  1.8750];                                                     
	[-1.1200, -2.0000,  1.3500];                                                     
	[-2.0000, -1.1200,  1.3500];                                                     
	[-2.0000,  0.0000,  1.3500];                                                     
	[-1.1200, -2.0000,  0.9000];                                                     
	[-2.0000, -1.1200,  0.9000];                                                     
	[-2.0000,  0.0000,  0.9000];                                                     
	[-1.7500,  0.9800,  1.8750];                                                     
	[-0.9800,  1.7500,  1.8750];                                                     
	[ 0.0000,  1.7500,  1.8750];                                                     
	[-2.0000,  1.1200,  1.3500];                                                     
	[-1.1200,  2.0000,  1.3500];                                                     
	[ 0.0000,  2.0000,  1.3500];                                                     
	[-2.0000,  1.1200,  0.9000];                                                     
	[-1.1200,  2.0000,  0.9000];                                                     
	[ 0.0000,  2.0000,  0.9000];                                                     
	[ 0.9800,  1.7500,  1.8750];                                                     
	[ 1.7500,  0.9800,  1.8750];                                                     
	[ 1.1200,  2.0000,  1.3500];                                                     
	[ 2.0000,  1.1200,  1.3500];                                                     
	[ 1.1200,  2.0000,  0.9000];                                                     
	[ 2.0000,  1.1200,  0.9000];                                                     
	[ 2.0000,  0.0000,  0.4500];                                                     
	[ 2.0000, -1.1200,  0.4500];                                                     
	[ 1.1200, -2.0000,  0.4500];                                                     
	[ 0.0000, -2.0000,  0.4500];                                                     
	[ 1.5000,  0.0000,  0.2250];                                                     
	[ 1.5000, -0.8400,  0.2250];                                                     
	[ 0.8400, -1.5000,  0.2250];                                                     
	[ 0.0000, -1.5000,  0.2250];                                                     
	[ 1.5000,  0.0000,  0.1500];                                                     
	[ 1.5000, -0.8400,  0.1500];                                                     
	[ 0.8400, -1.5000,  0.1500];                                                     
	[ 0.0000, -1.5000,  0.1500];                                                     
	[-1.1200, -2.0000,  0.4500];                                                     
	[-2.0000, -1.1200,  0.4500];                                                     
	[-2.0000,  0.0000,  0.4500];                                                     
	[-0.8400, -1.5000,  0.2250];                                                     
	[-1.5000, -0.8400,  0.2250];                                                     
	[-1.5000,  0.0000,  0.2250];                                                     
	[-0.8400, -1.5000,  0.1500];                                                     
	[-1.5000, -0.8400,  0.1500];                                                     
	[-1.5000,  0.0000,  0.1500];                                                     
	[-2.0000,  1.1200,  0.4500];                                                     
	[-1.1200,  2.0000,  0.4500];                                                     
	[ 0.0000,  2.0000,  0.4500];                                                     
	[-1.5000,  0.8400,  0.2250];                                                     
	[-0.8400,  1.5000,  0.2250];                                                     
	[ 0.0000,  1.5000,  0.2250];                                                     
	[-1.5000,  0.8400,  0.1500];                                                     
	[-0.8400,  1.5000,  0.1500];                                                     
	[ 0.0000,  1.5000,  0.1500];                                                     
	[ 1.1200,  2.0000,  0.4500];                                                     
	[ 2.0000,  1.1200,  0.4500];                                                     
	[ 0.8400,  1.5000,  0.2250];                                                     
	[ 1.5000,  0.8400,  0.2250];                                                     
	[ 0.8400,  1.5000,  0.1500];                                                     
	[ 1.5000,  0.8400,  0.1500];                                                     
	[-1.6000,  0.0000,  2.0250];                                                     
	[-1.6000, -0.3000,  2.0250];                                                     
	[-1.5000, -0.3000,  2.2500];                                                     
	[-1.5000,  0.0000,  2.2500];                                                     
	[-2.3000,  0.0000,  2.0250];                                                     
	[-2.3000, -0.3000,  2.0250];                                                     
	[-2.5000, -0.3000,  2.2500];                                                     
	[-2.5000,  0.0000,  2.2500];                                                     
	[-2.7000,  0.0000,  2.0250];                                                     
	[-2.7000, -0.3000,  2.0250];                                                     
	[-3.0000, -0.3000,  2.2500];                                                     
	[-3.0000,  0.0000,  2.2500];                                                     
	[-2.7000,  0.0000,  1.8000];                                                     
	[-2.7000, -0.3000,  1.8000];                                                     
	[-3.0000, -0.3000,  1.8000];                                                     
	[-3.0000,  0.0000,  1.8000];                                                     
	[-1.5000,  0.3000,  2.2500];                                                     
	[-1.6000,  0.3000,  2.0250];                                                     
	[-2.5000,  0.3000,  2.2500];                                                     
	[-2.3000,  0.3000,  2.0250];                                                     
	[-3.0000,  0.3000,  2.2500];                                                     
	[-2.7000,  0.3000,  2.0250];                                                     
	[-3.0000,  0.3000,  1.8000];                                                     
	[-2.7000,  0.3000,  1.8000];                                                     
	[-2.7000,  0.0000,  1.5750];                                                     
	[-2.7000, -0.3000,  1.5750];                                                     
	[-3.0000, -0.3000,  1.3500];                                                     
	[-3.0000,  0.0000,  1.3500];                                                     
	[-2.5000,  0.0000,  1.1250];                                                     
	[-2.5000, -0.3000,  1.1250];                                                     
	[-2.6500, -0.3000,  0.9375];                                                     
	[-2.6500,  0.0000,  0.9375];                                                     
	[-2.0000, -0.3000,  0.9000];                                                     
	[-1.9000, -0.3000,  0.6000];                                                     
	[-1.9000,  0.0000,  0.6000];                                                     
	[-3.0000,  0.3000,  1.3500];                                                     
	[-2.7000,  0.3000,  1.5750];                                                     
	[-2.6500,  0.3000,  0.9375];                                                     
	[-2.5000,  0.3000,  1.1250];                                                     
	[-1.9000,  0.3000,  0.6000];                                                     
	[-2.0000,  0.3000,  0.9000];                                                     
	[ 1.7000,  0.0000,  1.4250];                                                     
	[ 1.7000, -0.6600,  1.4250];                                                     
	[ 1.7000, -0.6600,  0.6000];                                                     
	[ 1.7000,  0.0000,  0.6000];                                                     
	[ 2.6000,  0.0000,  1.4250];                                                     
	[ 2.6000, -0.6600,  1.4250];                                                     
	[ 3.1000, -0.6600,  0.8250];                                                     
	[ 3.1000,  0.0000,  0.8250];                                                     
	[ 2.3000,  0.0000,  2.1000];                                                     
	[ 2.3000, -0.2500,  2.1000];                                                     
	[ 2.4000, -0.2500,  2.0250];                                                     
	[ 2.4000,  0.0000,  2.0250];                                                     
	[ 2.7000,  0.0000,  2.4000];                                                     
	[ 2.7000, -0.2500,  2.4000];                                                     
	[ 3.3000, -0.2500,  2.4000];                                                     
	[ 3.3000,  0.0000,  2.4000];                                                     
	[ 1.7000,  0.6600,  0.6000];                                                     
	[ 1.7000,  0.6600,  1.4250];                                                     
	[ 3.1000,  0.6600,  0.8250];                                                     
	[ 2.6000,  0.6600,  1.4250];                                                     
	[ 2.4000,  0.2500,  2.0250];                                                     
	[ 2.3000,  0.2500,  2.1000];                                                     
	[ 3.3000,  0.2500,  2.4000];                                                     
	[ 2.7000,  0.2500,  2.4000];                                                     
	[ 2.8000,  0.0000,  2.4750];                                                     
	[ 2.8000, -0.2500,  2.4750];                                                     
	[ 3.5250, -0.2500,  2.4938];                                                     
	[ 3.5250,  0.0000,  2.4938];                                                     
	[ 2.9000,  0.0000,  2.4750];                                                     
	[ 2.9000, -0.1500,  2.4750];                                                     
	[ 3.4500, -0.1500,  2.5125];                                                     
	[ 3.4500,  0.0000,  2.5125];                                                     
	[ 2.8000,  0.0000,  2.4000];                                                     
	[ 2.8000, -0.1500,  2.4000];                                                     
	[ 3.2000, -0.1500,  2.4000];                                                     
	[ 3.2000,  0.0000,  2.4000];                                                     
	[ 3.5250,  0.2500,  2.4938];                                                     
	[ 2.8000,  0.2500,  2.4750];                                                     
	[ 3.4500,  0.1500,  2.5125];                                                     
	[ 2.9000,  0.1500,  2.4750];                                                     
	[ 3.2000,  0.1500,  2.4000];                                                     
	[ 2.8000,  0.1500,  2.4000];                                                     
	[ 0.0000,  0.0000,  3.1500];                                                     
	[ 0.0000, -0.0020,  3.1500];                                                     
	[ 0.0020,  0.0000,  3.1500];                                                     
	[ 0.8000,  0.0000,  3.1500];                                                     
	[ 0.8000, -0.4500,  3.1500];                                                     
	[ 0.4500, -0.8000,  3.1500];                                                     
	[ 0.0000, -0.8000,  3.1500];                                                     
	[ 0.0000,  0.0000,  2.8500];                                                     
	[ 0.2000,  0.0000,  2.7000];                                                     
	[ 0.2000, -0.1120,  2.7000];                                                     
	[ 0.1120, -0.2000,  2.7000];                                                     
	[ 0.0000, -0.2000,  2.7000];                                                     
	[-0.0020,  0.0000,  3.1500];                                                     
	[-0.4500, -0.8000,  3.1500];                                                     
	[-0.8000, -0.4500,  3.1500];                                                     
	[-0.8000,  0.0000,  3.1500];                                                     
	[-0.1120, -0.2000,  2.7000];                                                     
	[-0.2000, -0.1120,  2.7000];                                                     
	[-0.2000,  0.0000,  2.7000];                                                     
	[ 0.0000,  0.0020,  3.1500];                                                     
	[-0.8000,  0.4500,  3.1500];                                                     
	[-0.4500,  0.8000,  3.1500];                                                     
	[ 0.0000,  0.8000,  3.1500];                                                     
	[-0.2000,  0.1120,  2.7000];                                                     
	[-0.1120,  0.2000,  2.7000];                                                     
	[ 0.0000,  0.2000,  2.7000];                                                     
	[ 0.4500,  0.8000,  3.1500];                                                     
	[ 0.8000,  0.4500,  3.1500];                                                     
	[ 0.1120,  0.2000,  2.7000];                                                     
	[ 0.2000,  0.1120,  2.7000];                                                     
	[ 0.4000,  0.0000,  2.5500];                                                     
	[ 0.4000, -0.2240,  2.5500];                                                     
	[ 0.2240, -0.4000,  2.5500];                                                     
	[ 0.0000, -0.4000,  2.5500];                                                     
	[ 1.3000,  0.0000,  2.5500];                                                     
	[ 1.3000, -0.7280,  2.5500];                                                     
	[ 0.7280, -1.3000,  2.5500];                                                     
	[ 0.0000, -1.3000,  2.5500];                                                     
	[ 1.3000,  0.0000,  2.4000];                                                     
	[ 1.3000, -0.7280,  2.4000];                                                     
	[ 0.7280, -1.3000,  2.4000];                                                     
	[ 0.0000, -1.3000,  2.4000];                                                     
	[-0.2240, -0.4000,  2.5500];                                                     
	[-0.4000, -0.2240,  2.5500];                                                     
	[-0.4000,  0.0000,  2.5500];                                                     
	[-0.7280, -1.3000,  2.5500];                                                     
	[-1.3000, -0.7280,  2.5500];                                                     
	[-1.3000,  0.0000,  2.5500];                                                     
	[-0.7280, -1.3000,  2.4000];                                                     
	[-1.3000, -0.7280,  2.4000];                                                     
	[-1.3000,  0.0000,  2.4000];                                                     
	[-0.4000,  0.2240,  2.5500];                                                     
	[-0.2240,  0.4000,  2.5500];                                                     
	[ 0.0000,  0.4000,  2.5500];                                                     
	[-1.3000,  0.7280,  2.5500];                                                     
	[-0.7280,  1.3000,  2.5500];                                                     
	[ 0.0000,  1.3000,  2.5500];                                                     
	[-1.3000,  0.7280,  2.4000];                                                     
	[-0.7280,  1.3000,  2.4000];                                                     
	[ 0.0000,  1.3000,  2.4000];                                                     
	[ 0.2240,  0.4000,  2.5500];                                                     
	[ 0.4000,  0.2240,  2.5500];                                                     
	[ 0.7280,  1.3000,  2.5500];                                                     
	[ 1.3000,  0.7280,  2.5500];                                                     
	[ 0.7280,  1.3000,  2.4000];                                                     
	[ 1.3000,  0.7280,  2.4000];                                                     
	[ 0.0000,  0.0000,  0.0000];                                                     
	[ 1.5000,  0.0000,  0.1500];                                                     
	[ 1.5000,  0.8400,  0.1500];                                                     
	[ 0.8400,  1.5000,  0.1500];                                                     
	[ 0.0000,  1.5000,  0.1500];                                                     
	[ 1.5000,  0.0000,  0.0750];                                                     
	[ 1.5000,  0.8400,  0.0750];                                                     
	[ 0.8400,  1.5000,  0.0750];                                                     
	[ 0.0000,  1.5000,  0.0750];                                                     
	[ 1.4250,  0.0000,  0.0000];                                                     
	[ 1.4250,  0.7980,  0.0000];
	[ 0.7980,  1.4250,  0.0000];
	[ 0.0000,  1.4250,  0.0000];
	[-0.8400,  1.5000,  0.1500];
	[-1.5000,  0.8400,  0.1500];
	[-1.5000,  0.0000,  0.1500];
	[-0.8400,  1.5000,  0.0750];
	[-1.5000,  0.8400,  0.0750];
	[-1.5000,  0.0000,  0.0750];
	[-0.7980,  1.4250,  0.0000];
	[-1.4250,  0.7980,  0.0000];
	[-1.4250,  0.0000,  0.0000];
	[-1.5000, -0.8400,  0.1500];
	[-0.8400, -1.5000,  0.1500];
	[ 0.0000, -1.5000,  0.1500];
	[-1.5000, -0.8400,  0.0750];
	[-0.8400, -1.5000,  0.0750];
	[ 0.0000, -1.5000,  0.0750];
	[-1.4250, -0.7980,  0.0000];
	[-0.7980, -1.4250,  0.0000];
	[ 0.0000, -1.4250,  0.0000];
	[ 0.8400, -1.5000,  0.1500];
	[ 1.5000, -0.8400,  0.1500];
	[ 0.8400, -1.5000,  0.0750];
	[ 1.5000, -0.8400,  0.0750];
	[ 0.7980, -1.4250,  0.0000];
	[ 1.4250, -0.7980,  0.0000]];

%%
    eul_angles = [0, 0, 0];
    Rxyz          = eul2rotm(eul_angles);
    
    teapotVertices = Rxyz*teapotVertices';
    teapotVertices = teapotVertices';
%%
divs = 16;
u_cells = 16; %Number of cells in the u
v_cells = 16; %Number of cells in the v
uv_cells = [u_cells, v_cells]';

u = linspace(0, 1, u_cells); %Parametric variable u
v = linspace(0, 1, v_cells); %Parametric variable v

controlPoints_cell = cell(4,4);
patches_struct = struct();

%
for np = [13 14 15 16] 
    % set the control points for the current patch 
    for i = 1:16
        controlPoints(i,1) = teapotVertices(teapotPatches(np,i),1);
        controlPoints(i,2) = teapotVertices(teapotPatches(np,i),2);
        controlPoints(i,3) = teapotVertices(teapotPatches(np,i),3);
    end
    patches_struct(np).controlPoints = controlPoints;
    
    %Convert the cell to cell array
    k = 1;
    for i = 1:4
        for j = 1:4
            controlPoints_cell{i,j} =  controlPoints(k,:);
            k = k+1;
        end
    end
    patches_struct(np).controlPoints_cell =  controlPoints_cell;
    
    % Generate Bezzier surface object
    bezzier_surf_geo_obj = BezzierSurfaceAndGeodesic(controlPoints_cell, uv_cells);

    R{1} = bezzier_surf_geo_obj.R_alt{1};
    R{2} = bezzier_surf_geo_obj.R_alt{2};
    R{3} = bezzier_surf_geo_obj.R_alt{3};
    
    patches_struct(np).R = R;
    
    % generate grid
    k = 1;
    P = zeros(divs*divs,3);

    for j = 1:divs
        for i=1:divs
            u_loc = u(i);
            v_loc = v(j);
            P(k,:)  = bezzier_surf_geo_obj.EvaluateBezzierSurfacePatch(u_loc, v_loc, controlPoints_cell)';
            k = k + 1;
        end
    end
    patches_struct(np).P =  P;

    P_x = reshape(P(:,1),16,[])';
    P_y = reshape(P(:,2),16,[])';
    P_z = reshape(P(:,3),16,[])';

    P_cell{1} = P_x;
    P_cell{2} = P_y;
    P_cell{3} = P_z;
    patches_struct(np).P = P;

    % face connectivity
    vertices = zeros(divs*4,1);
    for j = 1:divs
        k = 1;
        for i=1:divs

            vertices((k-1)*4 + 1) = (divs + 1)*j + i;
            vertices((k-1)*4 + 2) = (divs + 1)*(j + 1) + i;
            vertices((k-1)*4 + 3) = (divs + 1)*(j + 1) + i + 1;
            vertices((k-1)*4 + 4) = (divs + 1)*j + i + 1;

            k = k + 1;
        end
    end
    patches_struct(np).vertices = vertices;
    
    P = patches_struct(np).controlPoints;
    
    % Define the degree of the Bezier surface
    n = 3;
    
    % Define the start and end parameter values for the geodesic
    t_start = 0;
    t_end = 6.7;
    % 
    % Number of points on the geodesic curve
    num_points = 100;
    % 
    % Compute the geodesic on the Bezier surface
    t_span = linspace(t_start, t_end, num_points);
    
    
    
    % Create an instance of the BezierSurface class
    if np == 5
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.1, 0.1, -.1/2, 0.25/2]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 6
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 7
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 8
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 9
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 10
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 11
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 12
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 13
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 14
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 15
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 16
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 17
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    elseif np == 18
        u = linspace(0,1,16);
        v = linspace(0,1,16);

        u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
        surface = BezierSurface(P, n, u0, t_span, u, v);
    %  elseif np == 19
    %     u = linspace(0,1,16);
    %     v = linspace(0,1,16);
    % 
    %     u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
    %     surface = BezierSurface(P, n, u0, t_span, u, v);
    %  elseif np == 20
    %     u = linspace(0,1,16);
    %     v = linspace(0,1,16);
    % 
    %     u0 = [0.151564601943725	0	0.00635578272527076	0.0114873122283522]';
    %     surface = BezierSurface(P, n, u0, t_span, u, v);
    %  elseif np == 21
    %     u = linspace(0,1,16);
    %     v = linspace(0,1,16);
    % 
    %     u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
    %     surface = BezierSurface(P, n, u0, t_span, u, v);
    %  elseif np == 22
    %     u = linspace(0,1,16);
    %     v = linspace(0,1,16);
    % 
    %     u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
    %     surface = BezierSurface(P, n, u0, t_span, u, v);
    % elseif np == 23
    %     u = linspace(0,1,16);
    %     v = linspace(0,1,16);
    % 
    %     u0 = [0.151564601943725	0	0.0635578272527076	0.114873122283522]';
    %     surface = BezierSurface(P, n, u0, t_span, u, v);
    end
    
    alpha = surface.alpha;

    uv_cell{np} = surface.uv_alpha;
    
    surface.geodesicParams
    %% Geodesic curve related
    
    dt  = 1 / (length(alpha) - 1);
    ds  = surface.ds(1:end,:);
    
    %Change of arc length param wrt to t
    ds_dt = ds./dt;
    
    % Velocity/Tangent and acceleration vector
    dalpha       = (diff(alpha)')';
    d2alpha      = (diff(dalpha)')';
    
    dalpha_ds      = dalpha./ds(2:end,:);
    dalpha_ds_norm = vecnorm(dalpha_ds')';
    dalpha_ds_unit = dalpha_ds./dalpha_ds_norm;
    
    d2alpha_ds2      = diff(dalpha_ds)./ds(3:end,:);
    d2alpha_ds2_unit = d2alpha_ds2./vecnorm(d2alpha_ds2')';
    
    %Speed
    speed = dalpha_ds_norm;
    %Acceleration
    acc_alpha = d2alpha_ds2_unit;
    %% Serret-Frenet basis
    % Unit Tangent vector
    tou = dalpha_ds_unit;
    
    %Unit Normal vector to the curve
    nu = d2alpha_ds2_unit;
    
    % Unit alpha binormal vector
    beta = cross(tou(2:end,:),nu);
    
    %% Darboux basis
    u = surface.uv_alpha(:,1);
    v = surface.uv_alpha(:,2);
    
    % Surface derivatives
    dR_du = zeros(length(u),3);
    dR_dv = zeros(length(v),3);
    
    for i = 1:length(u)
        dR_du(i,:) = surface.derivativeU(u(i,:), v(i,:))';
        dR_dv(i,:) = surface.derivativeV(u(i,:), v(i,:))';
    end
    
    % Surface basis vector/Tangent plane
    rho1 =  dR_du./vecnorm(dR_du')';
    rho2 =  dR_dv./vecnorm(dR_dv')';
    
    % Surface normal
    n = cross(dR_du',dR_dv')'./vecnorm(cross(dR_du',dR_dv'))';
    
    %Curve Acceleration from rho1 and rho2
    du_ds = diff(u)./ds(2:end);
    dv_ds = diff(v)./ds(2:end);
    
    dalpha_ds_alt      = dR_du(2:end,:).*du_ds + dR_dv(2:end,:).*dv_ds;
    dalpha_ds_unit_alt = dalpha_ds_alt./vecnorm(dalpha_ds_alt')';
    
    cross_n_tangent         = cross(n(2:end,:)',dalpha_ds_unit')';
    cross_acc_alpha_tangent = cross(acc_alpha',dalpha_ds_unit(2:end,:)')';
    
    %% Projections for checking orientation of different vectors
    proj_acc_alpha_tangent       = dot(acc_alpha', tou(2:end,:)')';
    proj_dalphads_n              = dot(dalpha_ds_unit', n(2:end,:)')';
    
    proj_acc_alpha_surf_normal     = dot(d2alpha_ds2_unit', n(3:end,:)')';
    proj_acc_alpha_cross_n_tangent = dot(d2alpha_ds2_unit', cross_n_tangent(2:end,:)')';
    proj_surf_normal_cross_acc_alpha_tangent = dot(n(3:end,:)',cross_acc_alpha_tangent')';
    
    proj_rho1_rho2               = dot(rho1',rho2')';
    proj_rho1_surf_normal        = dot(rho1',n')';
    
    proj_acc_alpha_rho1          = dot(acc_alpha', rho1(3:end,:)')';
    
    % dot_n_cross_dalphads_d2alphads2 = dot(n(3:end,:)', cross_dalphads_d2alphads2' )';
    %% Plot the alphaezier surface and the geodesic curve
    figure
    gcf;gca;
    % surface.plot();
    hold on;
    figure(1), surf(surface.R(:,:,1), surface.R(:,:,2), surface.R(:,:,3),'FaceColor','flat'); hold on
    figure(1), plot3(controlPoints(:,1), controlPoints(:,2), controlPoints(:,3), 'o', 'MarkerFaceColor','k');
    xlabel('x')
    ylabel('y')
    zlabel('z')
    view([-30,20])
    plot3(alpha(:, 1), alpha(:, 2), alpha(:, 3), 'r', 'LineWidth', 2);
    
    scatter3(alpha(1, 1), alpha(1, 2), alpha(1, 3), 'filled','red');
    scatter3(alpha(end, 1), alpha(end, 2), alpha(end, 3), 'filled','green');

    %% Plot patch boundaries
    
    % Patch boundaries, u fixed and v varying
    plot3(surface.alpha_boundary{1}(:, 1), surface.alpha_boundary{1}(:, 2), surface.alpha_boundary{1}(:, 3), 'c', 'LineWidth', 2);
    plot3(surface.alpha_boundary{2}(:, 1), surface.alpha_boundary{2}(:, 2), surface.alpha_boundary{2}(:, 3), 'c', 'LineWidth', 2);
    %
    % Patch boundaries, v fixed and u varying
    plot3(surface.alpha_boundary{3}(:, 1), surface.alpha_boundary{3}(:, 2), surface.alpha_boundary{3}(:, 3), 'm', 'LineWidth', 2);
    plot3(surface.alpha_boundary{4}(:, 1), surface.alpha_boundary{4}(:, 2), surface.alpha_boundary{4}(:, 3), 'm', 'LineWidth', 2);
    
    
    
    % %Tangent plane
    % plot_span = 1:20*num_points/100:num_points;
    % 
    % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
    %             rho1(plot_span,1), rho1(plot_span,2), rho1(plot_span,3),'Color','r');
    % 
    % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
    %             rho2(plot_span,1), rho2(plot_span,2), rho2(plot_span,3),'Color','r');
    % 
    % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
    %             n(plot_span,1), n(plot_span,2), n(plot_span,3),'Color','g');
    % 
    % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
    %             dalpha_ds_unit(plot_span,1), dalpha_ds_unit(plot_span,2), dalpha_ds_unit(plot_span,3),'Color','k');
    % 
    % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
    %             acc_alpha(plot_span,1),  acc_alpha(plot_span,2),  acc_alpha(plot_span,3),'Color','b');
    % % 
    % % quiver3(alpha(plot_span,1), alpha(plot_span,2), alpha(plot_span,3), ...
% %             nu(plot_span,1),  nu(plot_span,2),  nu(plot_span,3),'Color','c');
end
hold off
%%
% figure;hold on
% plot(uv_cell{1}(:,1),uv_cell{1}(:,2) ,'r', 'LineWidth', 2);
% plot(uv_cell{5}(:,1)+(uv_cell{1}(end,1) - uv_cell{5}(1,1)),...
%      uv_cell{5}(:,2)+(uv_cell{1}(end,2) - uv_cell{5}(1,2)) ,'b', 'LineWidth', 2);
% 
% figure;hold on
% plot(uv_cell{1}(:,3),uv_cell{1}(:,4) ,'r', 'LineWidth', 2);
% plot(uv_cell{5}(:,3)+(uv_cell{1}(end,3) - uv_cell{5}(1,3)),...
%      uv_cell{5}(:,4)+(uv_cell{1}(end,4) - uv_cell{5}(1,4)) ,'b', 'LineWidth', 2);